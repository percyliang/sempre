$(function(){function e(e,t){var n=[]
return e.split(/\n/).forEach(function(e){e=e.replace(/\s+/g," ").replace(/^ | $/g,""),e.length&&n.push(e)}),n.join(t?" ":"\n")}function t(){$("#usedReasons").hide(),$("#usedReasons ul").empty()
for(var t=0;t<u.length;t++){var n=c[t].b
if(!n.prop("disabled")){n.val(e(n.val(),!0))
var a=n.val(),s=!1
if(!a.length)continue
$("#usedReasons ul li").each(function(e,t){return $(t).text()===a?(s=!0,!1):void 0}),s||($("#usedReasons").show(),$("<li>").text(a).appendTo("#usedReasons ul").click(function(t){if(t.ctrlKey){c[h].cb.click()
var n=c[h].b
n.val(e(n.val()+" "+$(this).text()))}}))}}}function n(e){$("#showingInstruction").toggle(!!e),$("#hidingInstruction").toggle(!e)}function a(e){$(".question, .table").hide(),u[e].show(),p[e].show(),$("html, body").scrollTop(0),$("#qNum").text(""+(e+1)+" / "+u.length),$("#prevButton").prop("disabled",0===e),$("#nextButton").toggle(e!==u.length-1),$("#submitButton").toggle(e===u.length-1),h=e,$("#qNum").trigger("questionChanged")
var n=c[h].a,a=c[h].b
n.prop("disabled")||n.focus(),a.prop("disabled")||a.focus(),t()}function s(e){var t=/^[0-9,.]*/.exec(e)
return null===t?null:(t=t[0].replace(/,/g,""),""===t?null:+t)}function i(t,n,a,i,o,r){function l(){b.empty().append(u),g.forEach(function(e){b.append(e)}),u.children().removeClass("selected"),m.prop("disabled",!0),v.text("(original order)"),r.val(r.val()+"O;")}function d(){var e=0
sum=0,numbers=[],b.find("td.selected").get().forEach(function(t){e++
var n=s($(t).text().replace(/^[^0-9]*/,""))
null!==n&&(numbers.push(n),sum+=n)}),0==e?f.text("").attr("title",null):(f.text("count = "+e+" | sum = "+sum+" (hover for details)"),f.attr("title","sum = "+(numbers.length?numbers.join(" + "):"(none)")))}var u,p,c,h,b=$("<table>"),g=[]
for(c=0;c<t.length;c++){for(p=$("<tr>"),h=0;h<t[0].length;h++)$(0===c?"<th>":"<td>").html(n[t[c][h]]).appendTo(p)
0==c&&(u=p),g.push(p)}var m=$("<button>").text("Restore row order").appendTo(a).click(l)
a.append(" ")
var v=$("<span>").appendTo(a)
l(),b.on("click","th",function(e){h=$(this).index()
var t=[],n=b.find("tr").get()
for(c=1;c<n.length;c++)t.push(c)
t.sort(function(e,t){var n=b.find("tr:eq("+e+") td:eq("+h+")").text(),a=b.find("tr:eq("+t+") td:eq("+h+")").text(),i=s(n),o=s(a)
if(null!==i){if(null===o)return-1
if(i!=o)return i-o}else if(null!==o)return 1
return n>a?1:a>n?-1:e-t}),b.empty().append(u),t.forEach(function(e){b.append(n[e])}),u.children().removeClass("selected"),$(this).addClass("selected"),m.prop("disabled",!1),v.text("(ordered by column "+(h+1)+")"),r.val(r.val()+"S"+h+";")}),a.append(" ")
var f=$("<span>").appendTo(a),w=!1
return b.on("mousedown","td",function(t){if(t.ctrlKey){i.click()
var n=o.val()
n.length&&"\n"!==n[n.length-1]&&(n+="\n"),o.val(n+e($(this).text(),!0)+"\n"),r.val(r.val()+"C"+$(this).parent().index()+"-"+$(this).index()+";"),t.preventDefault()}else t.shiftKey&&($(this).toggleClass("selected"),w=$(this).hasClass("selected"),d(),r.val(r.val()+"X"+$(this).parent().index()+"-"+$(this).index()+";"),t.preventDefault())}),b.on("mouseenter","td",function(e){e.shiftKey&&e.buttons>0&&($(this).toggleClass("selected",w),d(),r.val(r.val()+"X"+$(this).parent().index()+"-"+$(this).index()+";"),e.preventDefault())}),b}function o(e,t){return $("<input type=hidden>").attr("name",e+t)}function r(e,t){var n,a,s,r,l
u.push($("<div class=question>").appendTo("#questionWrapper").hide().append($("<fieldset>").append(o("id",t).val(e.id)).append(o("title",t).val(e.metadata.title)).append(o("url",t).val(e.metadata.url)).append(o("tableid",t).val(e.metadata.tableIndex)).append(o("question",t).val(e.question)).append(o("alterIndex",t).val(e.alterIndex)).append(o("otherAlterIndices",t).val(e.retained.otherAlterIndices)).append(o("score",t).val(e.retained.score)).append(l=o("actions",t).val("")).append($("<h2>Question</h2>")).append($("<div class=questionText>").text(e.question).addClass("q"+t)).append($("<p>").append($("<label>").attr("for","c"+t+"a").append(n=$("<input type=radio value=a checked=checked disabled>").attr("name","c"+t).attr("id","c"+t+"a").change(function(){r.prop("disabled",!0),a.prop("disabled",!1).focus()})).append("The answer is:"))).append(a=$("<textarea class=answerBox disabled rows=4>").attr("name","a"+t).attr("id","a"+t)).append($("<p>").append($("<label>").attr("for","c"+t+"b").append(s=$("<input type=radio value=b disabled>").attr("name","c"+t).attr("id","c"+t+"b").change(function(){a.prop("disabled",!0),r.prop("disabled",!1).focus()})).append("Cannot be answered because:"))).append(r=$("<textarea class=reasonBox disabled rows=2>").attr("name","b"+t).attr("id","b"+t))))
var d=$("<div class=table-info>"),h=i(e.table,e.sprite,d,n,a,l).addClass("q"+t)
p.push($("<div class=table>").hide().append(d).append($("<div class=table-lower>").append($("<h2>").append("Page Title: ").append($("<a target=_blank>").attr("href",e.metadata.url).text(e.metadata.title))).append(h)).appendTo("#webpage")),c.push({ca:n,a:a,cb:s,b:r})}function l(e){$("#webpage, #questionWrapper").empty(),e.forEach(r),$("#hideInstructionButton").text("Hide").prop("disabled",!1),n(!1),docCookies.getItem("percyTableSeenInstruction")!=d&&(n(!0),docCookies.setItem("percyTableSeenInstruction",d)),"ASSIGNMENT_ID_NOT_AVAILABLE"===$("#assignmentId").val()?n(!0):($(".question textarea.answerBox, .question input, #submitButton").prop("disabled",!1),$("#warning").hide()),a(0)}var d="5.2"
$("#content").html(["<div id=webpage class=column>&nbsp;</div>","<div id=wrapper class=column>","<div id=instruction>","<div id=hidingInstruction class=hidden><button type=button class=floatButton id=showInstructionButton>Show Instructions</button></div>","<div id=showingInstruction>","<h2>Task: Answer the question using the information from the table.</h2>","<button type=button class=floatButton id=hideInstructionButton disabled>Loading ...</button>","<ul>","<li>The tables were generated by shuffling the cells in some original table. Assume that each table presents data from a fictional world.</li>","<li>As such, some questions may sound a little strange (e.g., asking for <em>the city</em> but many cities fit the criteria). Please answer according to the intent of the question.</li>","<li>If the question really cannot be answered (e.g., when the main entity in the question is missing from the table, or when the table does not make sense), briefly describe the reason in the <strong>second box</strong> and leave the answer box blank.</li>","<li>We <strong>manually</strong> review the answers and check some of the answers with the gold standard. We use answers from other workers to detect suspicious submissions, but will not reject your work as long as it correctly follows the instructions.</li>","</ul>","<h2>Answer Format</h2>","<ul>","<li>If the answer appears in the table, please <strong>copy and paste</strong> to avoid typos.</li>","<li><strong>Do not</strong> add punctuation marks or elaboration to the answers: use <span class=whitebox>Paris</span> instead of <span class=redbox>Paris.</span> or <span class=redbox>Paris because it is in France</span>.</li>",'<li>If the answer is a <strong>number</strong>, please enter the number directly (e.g., <span class=whitebox>13</span>). <strong>Do not</strong> spell out the number (e.g., <span class=redbox>thirteen</span>), except when it is a <a target=_blank href="https://en.wikipedia.org/wiki/Thirteen_%282003_film%29">name</a>.</li>',"<li>If the answer is a <strong>list</strong> or has <strong>multiple parts</strong>, use multiple lines with <strong>one answer per line</strong> (e.g., <span class=whitebox>Paris</span> <kbd>Enter</kbd> <span class=whitebox>Madrid</span>, not <span class=redbox>Paris and Madrid</span>).</li>","</ul>","<h2>Tools</h2>","<ul>","<li><strong><kbd>Ctrl</kbd> (or <kbd>&#8984;</kbd>) + click on a table cell:</strong> copy cell content to the answer box.</li>","<li><strong>Hold <kbd>Shift</kbd> + paint on table cells:</strong> highlight cells and display statistics in the box above.</li>","<li><strong>Click on table header:</strong> sort the table by that column. (Note: does not work well on dates.)</li>","</ul>",'<p><em>If you have any problems or suggestions, please leave a comment or <a href="mailto:percyliangmturk@gmail.com?subject=%5BMTurk%5D%20table-alter" id=email>contact us</a>.</em></p>',"</div></div>","<div id=warning>Preview Mode<br>Please accept the HIT to start working.</div>","<div id=answerForm><div id=questionWrapper>&nbsp;</div>","<div id=navbar class=centerize>","<input type=hidden id=assignmentId name=assignmentId>","<button id=prevButton type=button>Previous</button> <span id=qNum>&nbsp;</span> <button id=nextButton type=button>Next</button> ","<button id=submitButton type=button class=hidden disabled><strong>Submit</strong></button>","</div>","<div id=usedReasons class=hidden><p>Used reasons (<kbd>Ctrl</kbd> + click to copy):</p><ul></ul></div>",'<p id=incompleteWarning class="red hidden"><strong>Error:</strong> Please answer all questions (Missing question <span id=missingQuestions>&nbsp;</span>)</p>',"</div></div>"].join(""))
var u=[],p=[],c=[],h=0,b=!1
$("#submitButton").click(function(){b=!0,$("#submitButton").closest("form").submit()}),$("#submitButton").keyup(function(e){var t=e.keyCode||e.which;(13===t||32===t)&&(b=!0,$("#submitButton").closest("form").submit())}),$("#submitButton").closest("form").submit(function(){if(!b)return!1
for(var t=[],n=0;n<u.length;n++){var a=c[n].a,s=c[n].b
a.val(e(a.val())),s.val(e(s.val(),!0)),(!a.prop("disabled")&&!a.val().length||!s.prop("disabled")&&!s.val().length)&&t.push(n+1)}return t.length?($("#missingQuestions").text(t.join(", ")),$("#incompleteWarning").show(),!1):($("#incompleteWarning").hide(),$("#submitButton").prop("disabled",!0),!0)}),$("#showInstructionButton").click(function(){n(!0)}),$("#hideInstructionButton").click(function(){n(!1)}),$("#prevButton").click(function(){a(h-1)}),$("#nextButton").click(function(){a(h+1)}),l(QUESTIONS)})
